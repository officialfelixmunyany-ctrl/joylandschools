{% extends "base.html" %}
{% load static %}

{% block title %}Teacher Dashboard - Joyland Schools{% endblock %}

{% block content %}
<style>
    .dashboard-section {
        padding: var(--space-8) 0;
    }

    .dashboard-header {
        background: var(--primary-gradient);
        color: white;
        padding: var(--space-12) var(--space-4);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-12);
        box-shadow: var(--shadow-2xl);
    }

    .dashboard-title {
        font-size: var(--font-size-4xl);
        font-weight: var(--font-weight-bold);
        margin-bottom: var(--space-2);
        animation: slideInUp 0.6s ease-out;
    }

    .dashboard-subtitle {
        opacity: 0.95;
        font-size: var(--font-size-lg);
        animation: slideInUp 0.8s ease-out;
    }

    .tool-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        backdrop-filter: blur(var(--glass-blur));
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        transition: all var(--transition-base);
        cursor: pointer;
        animation: fadeIn 0.6s ease-out;
    }

    .tool-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-xl);
        border-color: rgba(255, 255, 255, 0.4);
    }

    .tool-icon {
        font-size: var(--font-size-4xl);
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: var(--space-4);
    }

    .tool-title {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-bold);
        margin-bottom: var(--space-2);
    }

    .tool-description {
        color: var(--gray-600);
        font-size: var(--font-size-sm);
    }

    .loading-spinner {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
    }
    
    .spinner-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
    }
    
    .btn-loading {
        pointer-events: none;
        opacity: 0.6;
    }
    
    .cache-badge {
        display: inline-block;
        margin-left: 8px;
        padding: 2px 8px;
        background: var(--success);
        color: white;
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        animation: pulse 2s infinite;
    }
</style>

<div class="spinner-backdrop" id="spinnerBackdrop"></div>
<div class="loading-spinner" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-primary">Generating with AI...</p>
</div>

<div class="container-fluid py-4">
    <h1 class="mb-4">Teacher Dashboard</h1>

    <!-- Planning Tools Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Term Planning</h5>
                </div>
                <div class="card-body">
                    <form id="termPlanForm">
                        <div class="mb-3">
                            <label for="subject" class="form-label">Subject</label>
                            <select class="form-select" id="subject" required>
                                {% for subject, grades in subjects.items %}
                                <option value="{{ subject }}">{{ subject }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="grade" class="form-label">Grade Level</label>
                            <select class="form-select" id="grade" required>
                                <!-- Populated dynamically based on subject -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="term" class="form-label">Term</label>
                            <select class="form-select" id="term" required>
                                <option value="1">Term 1</option>
                                <option value="2" {% if current_term == 2 %}selected{% endif %}>Term 2</option>
                                <option value="3">Term 3</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Generate Term Plan</button>
                    </form>
                    <div id="termPlanResults" class="mt-3" style="display: none;">
                        <h6>Learning Objectives:</h6>
                        <div class="objectives-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Assessment Generator</h5>
                </div>
                <div class="card-body">
                    <form id="assessmentForm">
                        <div class="mb-3">
                            <label for="objective" class="form-label">Learning Objective</label>
                            <textarea class="form-control" id="objective" required rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="assessmentType" class="form-label">Assessment Type</label>
                            <select class="form-select" id="assessmentType">
                                <option value="formative">Formative</option>
                                <option value="summative">Summative</option>
                                <option value="diagnostic">Diagnostic</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="studentLevel" class="form-label">Student Level</label>
                            <select class="form-select" id="studentLevel">
                                <option value="support">Support</option>
                                <option value="standard">Standard</option>
                                <option value="extension">Extension</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Generate Assessment</button>
                    </form>
                    <div id="assessmentResults" class="mt-3" style="display: none;">
                        <h6>Assessment Items:</h6>
                        <div class="assessment-items"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Analysis Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Class Overview</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Class</th>
                                    <th>Support Level</th>
                                    <th>Standard Level</th>
                                    <th>Extension Level</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for class, profile in class_profiles.items %}
                                <tr>
                                    <td>{{ class }}</td>
                                    <td>{{ profile.support }}</td>
                                    <td>{{ profile.standard }}</td>
                                    <td>{{ profile.extension }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary generate-activities"
                                                data-class-id="{{ class|slugify }}">
                                            Generate Activities
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activities Modal -->
<div class="modal fade" id="activitiesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Differentiated Activities</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="activitiesForm">
                    <div class="mb-3">
                        <label for="activityObjective" class="form-label">Learning Objective</label>
                        <textarea class="form-control" id="activityObjective" required rows="3"></textarea>
                    </div>
                    <input type="hidden" id="classId">
                    <button type="submit" class="btn btn-primary">Generate Activities</button>
                </form>
                <div id="activitiesResults" class="mt-3" style="display: none;">
                    <h6>Suggested Activities:</h6>
                    <div class="activities-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Analysis Modal -->
<div class="modal fade" id="studentAnalysisModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Student Progress Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="analysisForm">
                    <div class="mb-3">
                        <label for="studentId" class="form-label">Student ID</label>
                        <input type="text" class="form-control" id="studentId" required>
                    </div>
                    <div class="mb-3">
                        <label for="analysisSubject" class="form-label">Subject</label>
                        <select class="form-select" id="analysisSubject" required>
                            {% for subject, grades in subjects.items %}
                            <option value="{{ subject }}">{{ subject }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Analyze Progress</button>
                </form>
                <div id="analysisResults" class="mt-3" style="display: none;">
                    <h6>Analysis Results:</h6>
                    <div class="analysis-content"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showLoadingSpinner(show = true) {
    const spinner = document.getElementById('loadingSpinner');
    const backdrop = document.getElementById('spinnerBackdrop');
    if (show) {
        spinner.style.display = 'block';
        backdrop.style.display = 'block';
    } else {
        spinner.style.display = 'none';
        backdrop.style.display = 'none';
    }
}

function showCacheBadge(resultsDiv) {
    const badge = document.createElement('span');
    badge.className = 'cache-badge';
    badge.textContent = 'âš¡ From Cache';
    resultsDiv.querySelector('h6').appendChild(badge);
}

document.addEventListener('DOMContentLoaded', function() {
    // Subject-Grade Level Dynamic Population
    const subjectSelect = document.getElementById('subject');
    const gradeSelect = document.getElementById('grade');
    const subjects = {{ subjects|safe }};

    function updateGradeLevels() {
        const selectedSubject = subjectSelect.value;
        const grades = subjects[selectedSubject];
        
        gradeSelect.innerHTML = '';
        grades.forEach(grade => {
            const option = document.createElement('option');
            option.value = grade;
            option.textContent = grade;
            gradeSelect.appendChild(option);
        });
    }

    subjectSelect.addEventListener('change', updateGradeLevels);
    updateGradeLevels();

    // Term Plan Generation
    document.getElementById('termPlanForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        showLoadingSpinner(true);
        
        try {
            const response = await fetch('/users/portal/teacher/generate-term-plan/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    subject: subjectSelect.value,
                    grade_level: gradeSelect.value,
                    term: document.getElementById('term').value
                })
            });

            const data = await response.json();
            const resultsDiv = document.getElementById('termPlanResults');
            const objectivesList = resultsDiv.querySelector('.objectives-list');
            
            if (response.ok) {
                objectivesList.innerHTML = data.objectives.map(obj => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>${obj.description}</h6>
                            <p><strong>Skills:</strong> ${obj.skills.join(', ')}</p>
                            <p><strong>Assessment Criteria:</strong> ${obj.assessment_criteria.join(', ')}</p>
                        </div>
                    </div>
                `).join('');
                
                if (data.cached) {
                    showCacheBadge(resultsDiv);
                }
                
                resultsDiv.style.display = 'block';
            } else {
                alert(data.error || 'Failed to generate term plan');
            }
        } finally {
            showLoadingSpinner(false);
        }
    });

    // Assessment Generation
    document.getElementById('assessmentForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        showLoadingSpinner(true);
        
        try {
            const response = await fetch('/users/portal/teacher/generate-assessment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    objective: document.getElementById('objective').value,
                    type: document.getElementById('assessmentType').value,
                    level: document.getElementById('studentLevel').value
                })
            });

            const data = await response.json();
            const resultsDiv = document.getElementById('assessmentResults');
            const itemsList = resultsDiv.querySelector('.assessment-items');
            
            if (response.ok) {
                itemsList.innerHTML = data.assessment_items.map(item => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>Question (${item.max_score} points):</h6>
                            <p>${item.question}</p>
                            <hr>
                            <h6>Rubric:</h6>
                            <p>${item.rubric}</p>
                            <hr>
                            <h6>Sample Answer:</h6>
                            <p>${item.sample_answer}</p>
                        </div>
                    </div>
                `).join('');
                
                if (data.cached) {
                    showCacheBadge(resultsDiv);
                }
                
                resultsDiv.style.display = 'block';
            } else {
                alert(data.error || 'Failed to generate assessment');
            }
        } finally {
            showLoadingSpinner(false);
        }
    });

    // Activities Generation
    document.querySelectorAll('.generate-activities').forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('classId').value = this.dataset.classId;
            const modal = new bootstrap.Modal(document.getElementById('activitiesModal'));
            modal.show();
        });
    });

    document.getElementById('activitiesForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        showLoadingSpinner(true);
        
        try {
            const response = await fetch('/users/portal/teacher/get-differentiated-activities/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    objective: document.getElementById('activityObjective').value,
                    class_id: document.getElementById('classId').value
                })
            });

            const data = await response.json();
            const resultsDiv = document.getElementById('activitiesResults');
            const activitiesList = resultsDiv.querySelector('.activities-list');
            
            if (response.ok) {
                activitiesList.innerHTML = data.activities.map(activity => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>${activity.level} Level</h6>
                            <p>${activity.description}</p>
                            <p><strong>Materials:</strong> ${activity.materials.join(', ')}</p>
                            <p><strong>Duration:</strong> ${activity.duration} minutes</p>
                        </div>
                    </div>
                `).join('');
                resultsDiv.style.display = 'block';
            } else {
                alert(data.error || 'Failed to generate activities');
            }
        } finally {
            showLoadingSpinner(false);
        }
    });

    // CSRF Token Helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}